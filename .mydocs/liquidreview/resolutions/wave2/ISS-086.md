# Resolution: ISS-086

## Status: ✅ RESOLVED

## Issue Summary
**Title:** Extremely Large Data Set
**Severity:** significant
**Target:** SPEC
**Section:** §9 Binding System, §11 Layout & Responsiveness System, §18 Adapter Interface Contract

## Resolution

### Original Content
The specification describes data binding but does not address performance implications of very large datasets or define strategies for pagination, virtualization, or data limiting.

Partial references:
- §9.1: `limit?: number` mentioned but not specified
- §B.3.2: `renderTimeout` mentioned but not tied to data size

### Replacement Content

**Add to §9.8 "Large Dataset Handling" (new subsection after §9.7):**

```markdown
### 9.8 Large Dataset Handling

The engine and adapters must handle arbitrarily large datasets without degrading performance or crashing.

#### 9.8.1 Dataset Size Classification

| Classification | Row Count | Strategy |
|----------------|-----------|----------|
| **Small** | < 100 rows | Render all (no special handling) |
| **Medium** | 100 - 1,000 rows | Apply default limits per block type |
| **Large** | 1,000 - 10,000 rows | Require pagination or virtualization |
| **Very Large** | > 10,000 rows | Enforce limits + show warning |

#### 9.8.2 Default Limits by Block Type

Blocks have intrinsic rendering limits based on visual utility:

| Block Type | Default Limit | Rationale | Overflow Behavior |
|------------|---------------|-----------|-------------------|
| **kpi** | 1 | Shows single aggregated value | N/A (aggregates all) |
| **bar-chart** | 50 | Too many bars unreadable | Show top N + "X more" |
| **line-chart** | 10,000 | Can handle many points | Downsample if > limit |
| **pie-chart** | 12 | Too many slices unreadable | Show top N + "Other" |
| **data-table** | 100 | Page size for initial render | Pagination required |
| **metric-group** | 20 | Visual space constraint | Show top N |

#### 9.8.3 Limit Specification in Binding

```typescript
interface DataBinding {
  // ... existing fields ...
  limit?: number;                    // Max rows to fetch/render
  limitStrategy?: LimitStrategy;     // How to handle overflow
}

type LimitStrategy =
  | 'truncate'          // Show first N items
  | 'top-n'             // Show top N by sort
  | 'sample'            // Random sample
  | 'aggregate-rest'    // Show N items + aggregated "Other"
  | 'paginate'          // Enable pagination
  | 'virtualize';       // Use virtual scrolling

interface LimitConfig {
  limit: number;
  strategy: LimitStrategy;
  showOverflowIndicator: boolean;   // Show "X more items" message
  overflowMessage?: string;
}
```

#### 9.8.4 Default Limit Strategies

| Block Type | Default Strategy | Behavior |
|------------|------------------|----------|
| **kpi** | (none) | Aggregates entire dataset |
| **bar-chart** | `top-n` with `limit: 50` | Show top 50 by value, sorted |
| **line-chart** | `truncate` with `limit: 10000` | Show first 10k points |
| **pie-chart** | `aggregate-rest` with `limit: 12` | Show top 12 + "Other" slice |
| **data-table** | `paginate` with `limit: 100` | Show 100 per page |
| **comparison** | (none) | Uses 1-2 rows only |

#### 9.8.5 LiquidCode Limit Syntax

```liquidcode
# Explicit limit specification
B$category$revenue:limit=20              # Show top 20 bars
T$orders:limit=50:paginate               # Table with 50 rows per page
P$region$sales:limit=8:aggregate         # Top 8 slices + "Other"
L$date$amount:limit=5000                 # Limit to 5000 points

# Default limits apply if not specified
B$category$revenue                       # Automatically limits to 50
```

#### 9.8.6 Overflow Indicators

When data exceeds limits, adapters MUST show indicators:

```typescript
interface OverflowIndicator {
  visible: boolean;
  totalCount: number;        // Total available items
  displayedCount: number;    // Items actually shown
  message: string;           // "Showing 50 of 1,234 items"
  action?: {
    type: 'paginate' | 'view-all' | 'download';
    label: string;
  };
}
```

**Example overflow messages:**
- Bar chart: "Showing top 50 of 1,234 categories"
- Pie chart: "Top 12 categories + Other (1,222 categories)"
- Table: "Page 1 of 25 (2,500 total records)"
- Line chart: "Downsampled from 50,000 points"

#### 9.8.7 Pagination Support

For blocks supporting pagination (primarily `data-table`):

```typescript
interface PaginationSpec {
  enabled: boolean;
  pageSize: number;           // Rows per page
  currentPage: number;        // 0-indexed
  totalPages: number;
  totalItems: number;
}

// Pagination signal integration
const tableWithPagination = {
  type: 'data-table',
  binding: {
    source: 'orders',
    limit: 100,
    limitStrategy: 'paginate',
  },
  signals: {
    emits: [
      { signal: '@pagination', trigger: 'onPageChange' }
    ],
    receives: [
      { signal: '@pagination', target: 'pagination.currentPage' }
    ],
  },
};
```

#### 9.8.8 Virtualization Support

For adapters supporting virtual scrolling:

```typescript
interface VirtualizationSpec {
  enabled: boolean;
  itemHeight: number | 'auto';     // Known height for efficient rendering
  overscan: number;                // Items to render outside viewport
  totalItems: number;
}

// Adapter capability
interface AdapterMetadata {
  // ... existing fields ...
  supportsVirtualization: boolean;
  maxVirtualizationItems?: number;  // e.g., 100,000
}
```

#### 9.8.9 Downsampling for Charts

Line/area charts may downsample large datasets:

```typescript
interface DownsamplingSpec {
  algorithm: 'lttb' | 'average' | 'min-max' | 'random';
  targetPoints: number;
  preservePeaks: boolean;          // Keep local min/max
}

// Default for line charts with > 10k points
const defaultDownsampling: DownsamplingSpec = {
  algorithm: 'lttb',                // Largest Triangle Three Buckets
  targetPoints: 5000,
  preservePeaks: true,
};
```

#### 9.8.10 Performance Guarantees

Adapters MUST meet performance criteria:

| Dataset Size | Operation | Max Time |
|--------------|-----------|----------|
| 1k rows | Initial render | < 500ms |
| 10k rows | Initial render (with limits) | < 1s |
| 100k rows | Initial render (with pagination) | < 1s |
| Any size | Page change | < 200ms |
| Any size | Filter application | < 500ms |

These are measured at P95 (95th percentile).

#### 9.8.11 Warning Thresholds

The engine warns users about large datasets:

```typescript
interface DataSizeWarning {
  severity: 'info' | 'warning' | 'error';
  threshold: number;
  message: string;
  recommendation: string;
}

const SIZE_WARNINGS: DataSizeWarning[] = [
  {
    severity: 'info',
    threshold: 1000,
    message: 'Large dataset detected (1,000+ rows)',
    recommendation: 'Consider applying filters or aggregation',
  },
  {
    severity: 'warning',
    threshold: 10000,
    message: 'Very large dataset (10,000+ rows)',
    recommendation: 'Pagination or limits strongly recommended',
  },
  {
    severity: 'error',
    threshold: 100000,
    message: 'Extremely large dataset (100,000+ rows)',
    recommendation: 'Pre-aggregate data or use database-level filtering',
  },
];
```

#### 9.8.12 Aggregation Optimization

For very large datasets, prefer aggregation over row-level rendering:

```liquidcode
# Instead of this (100k rows):
T$transactions

# Do this (aggregate first):
K$transactions:count
B$date$count:groupBy=date           # Aggregated by date
```

**Discovery engine should suggest aggregation** when detecting large datasets.

#### 9.8.13 Adapter Requirements for Large Data

```typescript
interface LiquidAdapter<T> {
  // ... existing methods ...

  // MUST implement efficient rendering for large datasets
  renderWithLimit(
    block: Block,
    data: any[],
    limit: LimitConfig
  ): T;

  // MUST support pagination for tables
  renderPaginated(
    block: Block,
    data: any[],
    pagination: PaginationSpec
  ): T;

  // MAY support virtualization
  supportsVirtualization(): boolean;

  // MUST complete within timeout regardless of data size
  readonly maxDatasetSize?: number;
}
```

#### 9.8.14 Example: Complete Large Dataset Handling

```liquidcode
#sales_analysis;G2x3
§pagination:pagination={page:0,size:100},url

# Aggregated KPI (handles any dataset size)
K$revenue:sum

# Top 20 products by revenue
B$product$revenue:top=20

# Time series (auto-downsamples if > 10k points)
L$date$revenue:groupBy=date

# Table with pagination
T$orders:limit=100:paginate<>@pagination

# Pie chart with "Other" aggregation
P$category$revenue:top=10:aggregate
```

#### 9.8.15 Conformance Tests

```typescript
const largeDataTests = [
  'renders 100k-row dataset without crashing',
  'applies default limits correctly per block type',
  'shows overflow indicators when data exceeds limit',
  'completes initial render within 1s for 10k-row table',
  'pagination changes page in < 200ms',
  'downsamples line chart from 50k to 5k points',
  'aggregates pie chart "Other" slice correctly',
  'warns when dataset exceeds 10k rows',
];
```
```

**Add to §B.3.2 "Adapter Conformance" (enhancement):**

```markdown
// Large dataset handling (MUST)
'completes render within timeout for large datasets',
'applies appropriate limits per block type',
'shows overflow indicators when data exceeds limits',
'supports pagination for tables',
'does not crash or hang on 100k+ row dataset',
```

## Verification Checklist
- [✓] Edge case fully specified (small, medium, large, very large datasets)
- [✓] Behavior deterministic (default limits, strategies, thresholds)
- [✓] Error handling defined (warnings, timeouts, overflow indicators)
- [✓] Examples provided (LiquidCode syntax, configuration, performance guarantees)

## Confidence
**HIGH** - This resolution:
1. Defines clear size classifications and strategies
2. Provides default limits per block type based on visual utility
3. Specifies multiple limit strategies (truncate, paginate, virtualize, etc.)
4. Includes performance guarantees with measurable criteria
5. Adds overflow indicators and user-facing messages
6. Integrates with existing signal system for pagination
7. Extends adapter interface with required methods
8. Provides conformance tests for validation
