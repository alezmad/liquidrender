# Wave 0 Bootstrap: Decisions & Required Wave Changes

**Date:** 2026-01-02
**Version:** 1.0
**Decision:** Option B - Enhanced Implementation (Editable Canvas + RBAC)

---

## Executive Summary

Wave 0 Bootstrap completed with architectural decisions that require scope adjustments in Waves 3 and 5. Total timeline increases from 16 to 18 days (+2 days). Core value proposition enhanced: users get auto-generated dashboards AND can customize them.

**Key Decisions:**
1. ✅ Canvas architecture: LiquidSchema-based (simple) over block-based (complex)
2. ✅ Canvas editing: Full editor with RBAC (not view-only)
3. ✅ Layout responsibility: LiquidRender owns all positioning (DashboardSpec is data-only)
4. ✅ RBAC implementation: Wave 3 (bundled with canvas)

**Timeline Impact:**
- Original: 16 days
- Updated: 18 days (+2 days in Wave 3)
- Waves 1, 2, 4, 5: No changes

---

## Part 1: Wave 0 Decisions

### Decision 1: Canvas Architecture (LiquidSchema-Based)

**Context:** Database schema had block-based canvas (3 tables: canvas, canvas_block, canvas_alert). We evaluated two options.

**Decision:** Replace with LiquidSchema-based single table.

**What Changed:**
```sql
-- REMOVED (block-based)
knosia_canvas (container)
knosia_canvas_block (individual blocks with position)
knosia_canvas_alert (per-block alerts)

-- ADDED (LiquidSchema-based)
knosia_workspace_canvas (
  id, workspaceId UNIQUE,
  schema JSONB,              -- Complete LiquidSchema
  sourceType ENUM,           -- template | custom | hybrid
  templateId TEXT,           -- e.g., "saas"
  lastEditedBy TEXT
)
```

**Enum Changes:**
```typescript
// REMOVED
knosiaCanvasStatusEnum (draft/active/archived)
knosiaCanvasBlockTypeEnum (kpi/line_chart/bar_chart/hero_metric/text...)

// ADDED
knosiaCanvasSourceTypeEnum (template/custom/hybrid)
```

**Rationale:**
- ✅ Simpler: Single source of truth (LiquidSchema)
- ✅ Faster: No block-to-schema conversion overhead
- ✅ Cleaner: LiquidRender owns layout entirely
- ✅ Flexible: Full LiquidRender power available
- ⚠️ Trade-off: Editing = replace entire JSON (not granular blocks)

**Impact on Waves:**
- Wave 1: None
- Wave 2: None (already generates LiquidSchema)
- Wave 3: **Scope increase** (see below)
- Wave 4: None
- Wave 5: None

---

### Decision 2: DashboardSpec = Data Contract Only

**Context:** Risk of layout logic duplication between DashboardSpec and LiquidSchema.

**Decision:** DashboardSpec contains ONLY data (KPIs, queries, business type). NO layout fields.

**What We Removed:**
```typescript
// ❌ REMOVED from DashboardSpec
layout?: CanvasLayoutConfig;  // Grid config

// ❌ REMOVED from DashboardSection
position?: { row, col, width };  // Block positioning
```

**What We Kept:**
```typescript
// ✅ DashboardSpec - Data contract
interface DashboardSpec {
  businessType: string;
  sections: DashboardSection[];  // What to show (not how)
  coverage: number;
  warnings: string[];
}

// ✅ Layout lives in LiquidSchema
// Generated by dashboardSpecToLiquidSchema() in Wave 2
```

**Responsibility Boundaries:**
| Layer | Responsibility | Example |
|-------|----------------|---------|
| **DashboardSpec** | What data to show | "Show MRR, Churn, CAC" |
| **LiquidSchema** | How to lay it out | "MRR in 4-col grid at position 0,0" |
| **WorkspaceCanvas** | Persistence | Saves LiquidSchema to database |

**Impact on Waves:**
- Wave 1: None
- Wave 2: ✅ Already planned this way
- Wave 3: ✅ Cleaner integration
- Wave 4: None
- Wave 5: None

---

### Decision 3: Canvas Editing Scope (Full Editor, Not View-Only)

**Context:** Original Wave 3 plan was view-only canvas (just render DashboardSpec). We discussed adding editing capabilities.

**Decision:** Implement full canvas editor with drag-drop, RBAC, save/load in Wave 3.

**Original Wave 3 Task 5:**
```typescript
// 50 LOC, 0.5 days - View only
export function CanvasFromDashboardSpec({ spec }) {
  const liquidSchema = dashboardSpecToLiquidSchema(spec);
  return <LiquidUI schema={liquidSchema} data={{}} />;
}
```

**Enhanced Wave 3 Task 4 (replaces Task 5):**
```typescript
// 420 LOC, 2 days - Full editor with RBAC
export function CanvasWorkspace({ workspaceId, initialSpec }) {
  const [mode, setMode] = useState<'view' | 'edit'>('view');
  const permissions = useCanvasPermissions(workspaceId); // RBAC

  const { data: savedCanvas } = useQuery(...); // Load from DB

  return (
    <div>
      {permissions.canEdit && (
        <CanvasEditorToolbar
          mode={mode}
          onModeChange={setMode}
          onReset={() => resetToTemplate()}
        />
      )}

      {mode === 'edit' ? (
        <EditableCanvas schema={schema} onSave={saveCanvas} />
      ) : (
        <LiquidUI schema={schema} data={data} />
      )}
    </div>
  );
}
```

**New Components Required (Wave 3):**
1. **CanvasEditorToolbar** (~50 LOC) - Edit/Done toggle, Reset button
2. **BlockPalette** (~100 LOC) - Drag vocabulary items to canvas
3. **EditableCanvas** (~150 LOC) - DnD wrapper around LiquidUI
4. **CanvasSerializer** (~100 LOC) - Save/load LiquidSchema to DB
5. **Canvas API** (~100 LOC) - GET/POST endpoints with RBAC
6. **useCanvasPermissions hook** (~30 LOC) - Permission checks

**Total Addition:** +420 LOC, +1.5 days to Wave 3

**Impact on Waves:**
- Wave 3: **Scope increase** (see Part 2)
- All other waves: No impact

---

### Decision 4: RBAC Implementation (Wave 3, Not Wave 5)

**Context:** Canvas editing requires permissions. Original waves had no RBAC plan.

**Decision:** Implement RBAC in Wave 3 alongside canvas editor.

**RBAC Scope (V1):**
```typescript
interface CanvasPermissions {
  canView: boolean;    // All workspace members
  canEdit: boolean;    // Admins/owners only (from membership.permissions)
  canReset: boolean;   // Owners only
}

// Permission check pattern
const permissions = useCanvasPermissions(workspaceId);

// UI enforcement
{permissions.canEdit && <Button>Edit</Button>}

// API enforcement
if (!['admin', 'owner'].includes(membership.role)) {
  return c.json({ error: 'Forbidden' }, 403);
}
```

**Database Support (Already Exists):**
```typescript
knosiaWorkspaceMembership {
  userId, workspaceId, roleId
  permissions: JSONB {     // ✅ Already in schema
    canEdit?: boolean
    canInvite?: boolean
    canManageConnections?: boolean
    canApproveVocabulary?: boolean
  }
}
```

**RBAC Components (Wave 3):**
- `useCanvasPermissions()` hook (~30 LOC)
- API permission middleware (~50 LOC)
- Permission checks in UI (~20 LOC scattered)

**Total Addition:** ~100 LOC to Wave 3

**Impact on Waves:**
- Wave 3: **Scope increase** (see Part 2)
- Wave 5: No longer needs RBAC group

---

## Part 2: Required Wave Changes

### Wave 1: Foundation ✅ NO CHANGES

**Status:** Fully compatible, proceed as planned.

**What Wave 1 Does:**
- Business type detector
- Business type signatures
- Templates (SaaS, E-commerce, Generic)
- Template mapper

**Dependencies on Wave 0:**
- Uses `BusinessType`, `BusinessTypeTemplate`, `DetectionResult` types ✅
- No canvas/dashboard dependencies ✅

**Verdict:** Proceed with original plan (550 LOC, 2 days, PARALLEL).

---

### Wave 2: Glue Code ✅ NO CHANGES

**Status:** Fully compatible, proceed as planned.

**What Wave 2 Does:**
- Phase 2.1-A: `saveDetectedVocabulary()` - Write to DB
- Phase 2.1-B: `generateSemanticLayer()` - Compile vocabulary
- Phase 2.2: `generateDashboardSpec()` - Business type → DashboardSpec
- Phase 2.3: `dashboardSpecToLiquidSchema()` - DashboardSpec → LiquidSchema

**Alignment with Wave 0 Decisions:**
- ✅ DashboardSpec is data-only (no layout fields) - matches Decision 2
- ✅ LiquidSchema generator adds all positioning - matches Decision 2
- ✅ No canvas dependencies - compatible

**Verdict:** Proceed with original plan (700 LOC, 3 days, MIXED).

---

### Wave 3: Integration ⚠️ SCOPE INCREASE

**Status:** Requires significant additions for canvas editing + RBAC.

**Original Plan:**
- Duration: 4 days
- LOC: ~600
- Task 5: Canvas Integration (50 LOC, view-only)

**Updated Plan:**
- Duration: **5.5 days** (+1.5 days)
- LOC: **~1,020** (+420 LOC)
- Task 4: Canvas Editor + RBAC (420 LOC, editable with permissions)

---

#### Updated Wave 3 Task List

**Task 1: Pipeline Orchestrator** (unchanged)
- File: `packages/api/src/modules/knosia/pipeline/index.ts`
- LOC: ~150
- Duration: 1 day
- Dependencies: All Wave 2 glue functions

**Task 2: Analysis API** (unchanged)
- File: `packages/api/src/modules/knosia/analysis/router.ts`
- LOC: ~100
- Duration: 1 day
- Dependencies: Pipeline orchestrator

**Task 3: Onboarding Enhancement** (unchanged)
- Files: Onboarding flow modifications
- LOC: ~50
- Duration: 0.5 days
- Dependencies: Analysis API

**Task 4: Canvas Editor + RBAC** ⚠️ **CHANGED** (was "Canvas Integration")
- **Duration:** 2 days (was 0.5 days)
- **LOC:** ~420 (was ~50)
- **Dependencies:** Wave 2 complete, Analysis API, database migration

#### Task 4 Subtasks:

**4.1: Database Migration** (~20 LOC, 0.5 hours)
```bash
pnpm with-env -F @turbostarter/db db:generate
# Creates migration for:
# - CREATE ENUM knosia_canvas_source_type
# - DROP TABLE knosia_canvas_block, knosia_canvas_alert, knosia_canvas
# - CREATE TABLE knosia_workspace_canvas
pnpm with-env -F @turbostarter/db db:migrate
```

**4.2: Canvas API with RBAC** (~100 LOC, 0.5 days)

**File:** `packages/api/src/modules/knosia/canvas/router.ts` (create)

```typescript
import { Hono } from "hono";
import { enforceAuth } from "../../../middleware";
import { knosiaWorkspaceCanvas, knosiaWorkspaceMembership } from "@turbostarter/db/schema";
import { db } from "@turbostarter/db/server";
import { eq, and } from "drizzle-orm";
import { generateId } from "@turbostarter/shared/utils";

export const canvasRouter = new Hono()
  // GET /canvas/:workspaceId - Load canvas
  .get('/:workspaceId', enforceAuth, async (c) => {
    const { workspaceId } = c.req.param();
    const userId = c.get('user').id;

    // Check workspace membership (canView)
    const [membership] = await db
      .select()
      .from(knosiaWorkspaceMembership)
      .where(
        and(
          eq(knosiaWorkspaceMembership.workspaceId, workspaceId),
          eq(knosiaWorkspaceMembership.userId, userId)
        )
      )
      .limit(1);

    if (!membership) {
      return c.json({ error: 'Forbidden' }, 403);
    }

    // Get canvas
    const [canvas] = await db
      .select()
      .from(knosiaWorkspaceCanvas)
      .where(eq(knosiaWorkspaceCanvas.workspaceId, workspaceId))
      .limit(1);

    return c.json(canvas || null);
  })

  // POST /canvas/:workspaceId - Save canvas (requires canEdit)
  .post('/:workspaceId', enforceAuth, async (c) => {
    const { workspaceId } = c.req.param();
    const userId = c.get('user').id;
    const body = await c.req.json();

    // Check edit permission
    const [membership] = await db
      .select()
      .from(knosiaWorkspaceMembership)
      .where(
        and(
          eq(knosiaWorkspaceMembership.workspaceId, workspaceId),
          eq(knosiaWorkspaceMembership.userId, userId)
        )
      )
      .limit(1);

    if (!membership || !['admin', 'owner'].includes(membership.role)) {
      return c.json({ error: 'Forbidden - edit permission required' }, 403);
    }

    // Upsert canvas
    const [canvas] = await db
      .insert(knosiaWorkspaceCanvas)
      .values({
        id: generateId(),
        workspaceId,
        schema: body.schema,
        sourceType: body.sourceType || 'custom',
        templateId: body.templateId,
        lastEditedBy: userId,
      })
      .onConflictDoUpdate({
        target: knosiaWorkspaceCanvas.workspaceId,
        set: {
          schema: body.schema,
          sourceType: body.sourceType || 'hybrid',
          lastEditedBy: userId,
          updatedAt: new Date(),
        },
      })
      .returning();

    return c.json(canvas);
  });
```

**Issues:** CANVAS-001, RBAC-001

**4.3: useCanvasPermissions Hook** (~30 LOC, 0.5 hours)

**File:** `apps/web/src/modules/knosia/canvas/hooks/use-canvas-permissions.ts` (create)

```typescript
import { useQuery } from "@tanstack/react-query";
import { api } from "~/lib/api/client";
import { handle } from "@turbostarter/api/utils";

export function useCanvasPermissions(workspaceId: string) {
  // Get current user's membership
  const { data: membership } = useQuery({
    queryKey: ['workspace', workspaceId, 'membership'],
    queryFn: async () => {
      // Assuming membership endpoint exists or use existing org membership
      const res = await api.workspaces[':id'].membership.$get({
        param: { id: workspaceId }
      });
      return res.json();
    }
  });

  const role = membership?.role;

  return {
    canView: !!membership,
    canEdit: role === 'admin' || role === 'owner',
    canReset: role === 'owner',
  };
}
```

**Issues:** RBAC-002

**4.4: CanvasEditorToolbar** (~50 LOC, 0.25 days)

**File:** `apps/web/src/modules/knosia/canvas/components/canvas-editor-toolbar.tsx` (create)

```typescript
import { Button } from "@turbostarter/ui-web/button";

interface CanvasEditorToolbarProps {
  mode: 'view' | 'edit';
  onModeChange: (mode: 'view' | 'edit') => void;
  onReset: () => void;
  canEdit: boolean;
  canReset: boolean;
}

export function CanvasEditorToolbar({
  mode,
  onModeChange,
  onReset,
  canEdit,
  canReset,
}: CanvasEditorToolbarProps) {
  if (!canEdit) return null;

  return (
    <div className="flex items-center justify-between border-b p-4">
      <div className="flex gap-2">
        <Button
          variant={mode === 'view' ? 'default' : 'outline'}
          onClick={() => onModeChange(mode === 'view' ? 'edit' : 'view')}
        >
          {mode === 'view' ? 'Edit' : 'Done'}
        </Button>

        {mode === 'edit' && (
          <Button variant="outline" onClick={onReset} disabled={!canReset}>
            Reset to Template
          </Button>
        )}
      </div>
    </div>
  );
}
```

**Issues:** UI-013

**4.5: BlockPalette** (~100 LOC, 0.25 days)

**File:** `apps/web/src/modules/knosia/canvas/components/block-palette.tsx` (create)

```typescript
import { useState } from "react";
import { Input } from "@turbostarter/ui-web/input";
import { ScrollArea } from "@turbostarter/ui-web/scroll-area";

interface BlockPaletteProps {
  vocabularyItems: VocabularyItem[];
  onAddBlock: (item: VocabularyItem) => void;
}

export function BlockPalette({ vocabularyItems, onAddBlock }: BlockPaletteProps) {
  const [search, setSearch] = useState('');

  const filtered = vocabularyItems.filter(item =>
    item.canonicalName.toLowerCase().includes(search.toLowerCase())
  );

  return (
    <div className="w-64 border-r p-4">
      <Input
        placeholder="Search metrics..."
        value={search}
        onChange={(e) => setSearch(e.target.value)}
        className="mb-4"
      />

      <ScrollArea className="h-[calc(100vh-200px)]">
        <div className="space-y-2">
          {filtered.map(item => (
            <div
              key={item.id}
              className="p-2 border rounded cursor-pointer hover:bg-accent"
              onClick={() => onAddBlock(item)}
            >
              <div className="font-medium text-sm">{item.canonicalName}</div>
              <div className="text-xs text-muted-foreground">{item.type}</div>
            </div>
          ))}
        </div>
      </ScrollArea>
    </div>
  );
}
```

**Issues:** UI-014

**4.6: EditableCanvas** (~150 LOC, 0.5 days)

**File:** `apps/web/src/modules/knosia/canvas/components/editable-canvas.tsx` (create)

**Note:** This is a simplified wrapper. V1 editing will be basic:
- Add blocks by clicking from palette
- Remove blocks with delete button
- Reorder blocks with up/down buttons
- **No drag-drop in V1** (deferred to V1.1)

```typescript
import { useState } from "react";
import { LiquidUI } from "@repo/liquid-render";
import { Button } from "@turbostarter/ui-web/button";
import type { LiquidSchema } from "@repo/liquid-render";

interface EditableCanvasProps {
  schema: LiquidSchema;
  onSave: (schema: LiquidSchema) => void;
}

export function EditableCanvas({ schema, onSave }: EditableCanvasProps) {
  const [editedSchema, setEditedSchema] = useState(schema);

  const addBlock = (vocabularyItem: VocabularyItem) => {
    // Add new KPI block to schema
    const newBlock = {
      uid: generateBlockId(),
      type: 'kpi',
      binding: { kind: 'field', value: vocabularyItem.slug },
      label: vocabularyItem.canonicalName,
    };

    const updated = {
      ...editedSchema,
      layers: [{
        ...editedSchema.layers[0],
        root: {
          ...editedSchema.layers[0].root,
          children: [
            ...(editedSchema.layers[0].root.children || []),
            newBlock
          ]
        }
      }]
    };

    setEditedSchema(updated);
  };

  const removeBlock = (blockId: string) => {
    // Remove block from schema
    const updated = {
      ...editedSchema,
      layers: [{
        ...editedSchema.layers[0],
        root: {
          ...editedSchema.layers[0].root,
          children: editedSchema.layers[0].root.children.filter(
            b => b.uid !== blockId
          )
        }
      }]
    };

    setEditedSchema(updated);
  };

  return (
    <div className="relative">
      {/* Render with delete buttons on hover */}
      <LiquidUI schema={editedSchema} data={{}} />

      {/* Overlay delete buttons */}
      <BlockDeleteOverlay schema={editedSchema} onDelete={removeBlock} />

      {/* Save button */}
      <div className="fixed bottom-4 right-4">
        <Button onClick={() => onSave(editedSchema)}>
          Save Changes
        </Button>
      </div>
    </div>
  );
}
```

**Issues:** UI-015, CANVAS-002

**4.7: CanvasWorkspace (Main Component)** (~100 LOC, 0.5 days)

**File:** `apps/web/src/modules/knosia/canvas/components/canvas-workspace.tsx` (create)

```typescript
import { useState } from "react";
import { useQuery, useMutation } from "@tanstack/react-query";
import { api } from "~/lib/api/client";
import { dashboardSpecToLiquidSchema } from "@repo/liquid-render/dashboard";
import { LiquidUI } from "@repo/liquid-render";
import { CanvasEditorToolbar } from "./canvas-editor-toolbar";
import { EditableCanvas } from "./editable-canvas";
import { BlockPalette } from "./block-palette";
import { useCanvasPermissions } from "../hooks/use-canvas-permissions";

export function CanvasWorkspace({
  workspaceId,
  initialSpec
}: {
  workspaceId: string;
  initialSpec: DashboardSpec;
}) {
  const [mode, setMode] = useState<'view' | 'edit'>('view');
  const permissions = useCanvasPermissions(workspaceId);

  // Load saved canvas
  const { data: savedCanvas } = useQuery({
    queryKey: ['knosia', 'canvas', workspaceId],
    queryFn: async () => {
      const res = await api.knosia.canvas[':workspaceId'].$get({
        param: { workspaceId }
      });
      return res.json();
    }
  });

  // Save canvas mutation
  const saveMutation = useMutation({
    mutationFn: async (schema: LiquidSchema) => {
      const res = await api.knosia.canvas[':workspaceId'].$post({
        param: { workspaceId },
        json: {
          schema,
          sourceType: savedCanvas ? 'hybrid' : 'custom',
          templateId: initialSpec.businessType,
        }
      });
      return res.json();
    },
    onSuccess: () => {
      setMode('view');
    }
  });

  // Use saved canvas if exists, otherwise generate from spec
  const schema = savedCanvas?.schema
    ? savedCanvas.schema
    : dashboardSpecToLiquidSchema(initialSpec);

  // Reset to template
  const handleReset = () => {
    const templateSchema = dashboardSpecToLiquidSchema(initialSpec);
    saveMutation.mutate(templateSchema);
  };

  return (
    <div className="flex flex-col h-screen">
      <CanvasEditorToolbar
        mode={mode}
        onModeChange={setMode}
        onReset={handleReset}
        canEdit={permissions.canEdit}
        canReset={permissions.canReset}
      />

      <div className="flex flex-1 overflow-hidden">
        {mode === 'edit' && permissions.canEdit && (
          <BlockPalette
            vocabularyItems={[]} // Load from workspace vocabulary
            onAddBlock={(item) => {}}
          />
        )}

        <div className="flex-1 overflow-auto p-6">
          {mode === 'edit' ? (
            <EditableCanvas
              schema={schema}
              onSave={(s) => saveMutation.mutate(s)}
            />
          ) : (
            <LiquidUI schema={schema} data={{}} />
          )}
        </div>
      </div>
    </div>
  );
}
```

**Issues:** CANVAS-003, INT-002

---

**Task 5: HOME Page** (minor modification from Task 4)
- **File:** `apps/web/src/app/[locale]/dashboard/[organization]/knosia/page.tsx`
- **LOC:** ~50
- **Duration:** 0.5 days

```typescript
import { redirect } from "next/navigation";
import { getSession } from "~/lib/auth/server";
import { pathsConfig } from "~/config/paths";
import { CanvasWorkspace } from "~/modules/knosia/canvas";

export default async function KnosiaHomePage({
  params
}: {
  params: { organization: string }
}) {
  const { user } = await getSession();
  if (!user) return redirect(pathsConfig.auth.login);

  // Get workspace for org
  const workspace = await getWorkspaceForOrg(params.organization);

  // Get auto-generated dashboard spec
  const dashboardSpec = await getDashboardSpec(workspace.id);

  return (
    <CanvasWorkspace
      workspaceId={workspace.id}
      initialSpec={dashboardSpec}
    />
  );
}
```

**Issues:** UI-003, HOME-001

---

**Task 6: Routing & Navigation** (unchanged)
- Files: `paths.ts`, `layout.tsx`
- LOC: ~50
- Duration: 0.5 days
- **Note:** Remove `/canvas` route (HOME is the canvas now)

```typescript
// paths.ts
knosia: {
  home: (org: string) => `/dashboard/${org}/knosia`,  // Canvas IS home
  thread: (org: string) => `/dashboard/${org}/knosia/thread`,
  vocabulary: (org: string) => `/dashboard/${org}/knosia/vocabulary`,
  // NO separate /canvas route
}
```

**Issues:** NAV-001

---

#### Wave 3 Summary

**Updated Totals:**
- Duration: **5.5 days** (was 4 days, +1.5 days)
- LOC: **~1,020** (was ~600, +420 LOC)
- Files: **10** (was 6, +4 files)

**New Files:**
1. `packages/api/src/modules/knosia/canvas/router.ts`
2. `apps/web/src/modules/knosia/canvas/hooks/use-canvas-permissions.ts`
3. `apps/web/src/modules/knosia/canvas/components/canvas-editor-toolbar.tsx`
4. `apps/web/src/modules/knosia/canvas/components/block-palette.tsx`
5. `apps/web/src/modules/knosia/canvas/components/editable-canvas.tsx`
6. `apps/web/src/modules/knosia/canvas/components/canvas-workspace.tsx`

**Issues Closed:**
- Original: DASH-004, CANVAS-001, NAV-001
- Added: RBAC-001, RBAC-002, UI-013, UI-014, UI-015, CANVAS-002, CANVAS-003

---

### Wave 4: UI (Thread Interface) ✅ NO CHANGES

**Status:** Fully compatible, proceed as planned.

**What Wave 4 Does:**
- Thread page + view components
- Thread query hooks
- Thread backend integration
- Message display, query input, results rendering

**Dependencies on Wave 0:**
- Uses `knosiaThread`, `knosiaThreadMessage` tables ✅
- No canvas dependencies ✅
- Separate from canvas architecture ✅

**Verdict:** Proceed with original plan (400 LOC, 3 days, PARALLEL).

---

### Wave 5: Polish ✅ NO CHANGES

**Status:** Compatible, proceed as planned.

**What Wave 5 Does:**
- Group A: Error handling (pipeline, API, React boundaries)
- Group B: Loading states (skeletons, suspense, streaming)
- Group C: Responsive CSS (mobile, tablet, desktop)
- Group D: E2E tests (Playwright)

**RBAC Status:**
- ✅ Already implemented in Wave 3
- ✅ No additional RBAC work needed in Wave 5

**Verdict:** Proceed with original plan (3 days, PARALLEL).

---

## Part 3: Updated Project Timeline

### Original Timeline (16 days)

| Wave | Duration | LOC | Status |
|------|----------|-----|--------|
| 0: Bootstrap | 1 day | ~150 | ✅ Complete |
| 1: Foundation | 2 days | ~550 | Pending |
| 2: Glue Code | 3 days | ~700 | Pending |
| 3: Integration | 4 days | ~600 | Pending |
| 4: UI | 3 days | ~400 | Pending |
| 5: Polish | 3 days | Throughout | Pending |
| **Total** | **16 days** | **~2,400** | - |

---

### Updated Timeline (18 days)

| Wave | Duration | LOC | Change | Status |
|------|----------|-----|--------|--------|
| 0: Bootstrap | 1 day | ~196 | ✅ Complete (+46 LOC) | ✅ Done |
| 1: Foundation | 2 days | ~550 | No change | Pending |
| 2: Glue Code | 3 days | ~700 | No change | Pending |
| 3: Integration | **5.5 days** | **~1,020** | ⚠️ +1.5 days, +420 LOC | Pending |
| 4: UI | 3 days | ~400 | No change | Pending |
| 5: Polish | 3 days | Throughout | No change | Pending |
| **Total** | **18 days** | **~2,866** | **+2 days, +466 LOC** | - |

**Timeline Impact:**
- Original completion: Day 16
- Updated completion: Day 18
- Delay: +2 days (12.5% increase)
- LOC increase: +466 LOC (19% increase)

**Value Added:**
- ✅ Editable canvas (users can customize)
- ✅ RBAC (team permissions)
- ✅ Persistent canvas state (saves customizations)
- ✅ Template reset capability
- ✅ V1 ready for multi-user teams (not just solo users)

---

## Part 4: Implementation Checklist

### Pre-Wave 1 (Before Starting)

- [ ] Read this document fully
- [ ] Confirm Wave 3 scope increase understood (+1.5 days)
- [ ] Confirm RBAC bundled with canvas editing
- [ ] Review updated Wave 3 task list (Task 4 subtasks)
- [ ] Ensure database migration tools ready (`drizzle-kit`)

---

### Wave 1 Execution ✅ NO CHANGES

**Read:** `wave-1-foundation.md` (original, unmodified)

**Execute:**
- Group A: Business type detector + signatures
- Group B: Templates (SaaS, E-commerce, Generic)
- Group C: Template mapper + loader

**Verification:**
- All Wave 1 tests passing
- `detectBusinessType()` works for test schemas
- Templates load and validate

---

### Wave 2 Execution ✅ NO CHANGES

**Read:** `wave-2-glue-code.md` (original, unmodified)

**Execute:**
- Phase 2.1-A: `saveDetectedVocabulary()`
- Phase 2.1-B: `generateSemanticLayer()`
- Phase 2.2: `generateDashboardSpec()`
- Phase 2.3: `dashboardSpecToLiquidSchema()`

**Verification:**
- All glue functions have passing tests
- `dashboardSpecToLiquidSchema()` generates valid LiquidSchema
- **CRITICAL:** Verify DashboardSpec has NO layout fields

---

### Wave 3 Execution ⚠️ USE THIS DOCUMENT

**Read:** THIS DOCUMENT (Part 2, Wave 3 section) - **NOT** `wave-3-integration.md`

**Execute in order:**
1. Pipeline Orchestrator (1 day)
2. Analysis API (1 day)
3. Onboarding Enhancement (0.5 days)
4. **Canvas Editor + RBAC (2 days)** ← Use Task 4 from this document
   - 4.1: Database migration
   - 4.2: Canvas API with RBAC
   - 4.3: useCanvasPermissions hook
   - 4.4: CanvasEditorToolbar
   - 4.5: BlockPalette
   - 4.6: EditableCanvas
   - 4.7: CanvasWorkspace
5. HOME Page (0.5 days)
6. Routing (0.5 days)

**Verification:**
- Full pipeline runs end-to-end
- Canvas loads with auto-generated dashboard
- Edit button appears for admins/owners (not regular members)
- Canvas editing works (add/remove blocks)
- Canvas saves to `knosia_workspace_canvas` table
- Reset to template works
- Database migration applied successfully

**Critical Checks:**
- [ ] RBAC enforced in API (403 for non-admins)
- [ ] RBAC enforced in UI (no Edit button for viewers)
- [ ] Canvas persists across page reloads
- [ ] Template reset restores original spec

---

### Wave 4 Execution ✅ NO CHANGES

**Read:** `wave-4-ui.md` (original, unmodified)

**Execute:**
- Group A: Thread page + components
- Group B: Thread query hooks + backend

**Verification:**
- Thread interface loads
- Can ask questions
- Results display correctly

---

### Wave 5 Execution ✅ NO CHANGES

**Read:** `wave-5-polish.md` (original, unmodified)

**Execute:**
- Group A: Error handling
- Group B: Loading states
- Group C: Responsive CSS
- Group D: E2E tests

**Verification:**
- All error states handled
- Loading states everywhere
- Mobile responsive
- E2E tests passing

---

## Part 5: Risk & Mitigation

### Risk 1: Database Migration Complexity

**Risk:** Enum rename detection during migration generation may be confusing.

**Mitigation:**
- When `drizzle-kit generate` asks about enums, select **"+ create enum"**
- Do NOT select "rename enum" (we're replacing, not renaming)
- Review generated migration before running
- Test migration on dev database first

**Recovery:** If migration fails, restore schema to Wave 0 state and regenerate.

---

### Risk 2: Canvas Editing Complexity

**Risk:** LiquidSchema manipulation is complex, editing bugs likely.

**Mitigation:**
- **V1 Scope:** Simple add/remove blocks only (no drag-drop)
- Block IDs must be unique: use `generateBlockId()` function
- Validate schema before saving (ensure valid LiquidSchema structure)
- Add "Discard Changes" button (don't auto-save)

**Fallback:** If editing too complex, revert to view-only and defer to V1.1.

---

### Risk 3: RBAC Permission Bugs

**Risk:** Permission checks might be inconsistent between API and UI.

**Mitigation:**
- Single source of truth: `useCanvasPermissions()` hook
- API MUST check permissions independently (never trust frontend)
- Add permission check tests
- Manual testing matrix:
  - Owner: Can view, edit, reset ✅
  - Admin: Can view, edit, no reset ✅
  - Member: Can view only ✅
  - Non-member: 403 Forbidden ✅

**Recovery:** If RBAC too complex, make all workspace members admins in V1.

---

### Risk 4: Timeline Overrun

**Risk:** Wave 3 might take longer than 5.5 days.

**Mitigation:**
- Task 4 subtasks are sequential within the 2-day window
- If behind schedule by Day 4.5, cut BlockPalette (users can't add new blocks, only remove)
- If behind by Day 5, cut editing entirely (revert to view-only)

**Contingency:**
- Day 5.5: Ship view-only canvas if editing incomplete
- V1.1: Add editing after validation

---

## Part 6: V1 Feature Set (After Wave 5)

### What Users Get in V1

**Onboarding (60 seconds):**
1. Connect database
2. AI analyzes schema → Detects business type
3. Generates auto-filled dashboard

**Canvas (HOME Page):**
- ✅ Auto-generated dashboard with business-specific KPIs
- ✅ View mode (default)
- ✅ Edit mode (admins/owners only)
  - Add blocks from vocabulary
  - Remove blocks
  - Reorder blocks (up/down buttons, no drag-drop)
  - Save changes
  - Reset to template
- ✅ RBAC permissions enforced

**Thread (Conversation):**
- ✅ Ask questions in natural language
- ✅ Get visual answers (charts, tables)
- ✅ Query history
- ✅ Multiple threads

**Vocabulary:**
- ✅ Auto-detected metrics, dimensions, entities
- ✅ Browse vocabulary items
- ✅ Role-based suggestions

---

### What's Deferred to V1.1

- Drag-drop canvas editing (up/down buttons in V1)
- Canvas collaboration (multiplayer editing)
- Multiple named canvases per workspace
- Block-level permissions
- Canvas version history
- Pin Thread results to Canvas
- Custom vocabulary formulas (UI)
- Canvas alerts/notifications
- Canvas sharing (public links)

---

## Part 7: Success Criteria

### Wave 3 Success Criteria (Updated)

**Functional:**
- [ ] Pipeline runs end-to-end (database → canvas)
- [ ] Canvas loads with auto-generated dashboard
- [ ] Admins see Edit button, members don't
- [ ] Edit mode allows add/remove blocks
- [ ] Canvas saves and persists
- [ ] Reset to template works
- [ ] Forbidden (403) for non-members

**Technical:**
- [ ] Database migration applied successfully
- [ ] All TypeScript compiles
- [ ] All tests passing
- [ ] No console errors
- [ ] RBAC enforced in API and UI

**Quality:**
- [ ] Canvas renders correctly in LiquidRender
- [ ] Edited canvas survives page reload
- [ ] Template reset restores original KPIs
- [ ] Permission checks don't have race conditions

---

### Overall V1 Success Criteria

**User Journey:**
1. User connects database → Analysis completes in <60s ✅
2. User lands on Canvas → Sees relevant KPIs for their business ✅
3. Admin clicks Edit → Can customize canvas ✅
4. User switches to Thread → Can ask questions ✅
5. User navigates back to Canvas → Sees their saved customizations ✅

**Technical:**
- All 5 waves complete (18 days)
- ~2,866 LOC written
- TypeScript strict mode (no errors)
- E2E tests passing
- Responsive on mobile/tablet/desktop

**Business:**
- Product validates core value prop: "60 seconds to insights"
- Users can customize their view (not locked to templates)
- Multi-user teams supported (RBAC working)
- Ready for beta users

---

## Part 8: Quick Reference

### Key Type Definitions (Wave 0)

```typescript
// Business Types
type BusinessType = "saas" | "ecommerce" | "marketplace" | ...;
interface BusinessTypeTemplate { kpis, entities, dashboard };

// Dashboard (data only, no layout)
interface DashboardSpec {
  businessType: string;
  sections: DashboardSection[];
  coverage: number;
}

// Canvas (persistence)
interface WorkspaceCanvas {
  workspaceId: string;
  schema: unknown;  // LiquidSchema
  sourceType: "template" | "custom" | "hybrid";
  templateId?: string;
  lastEditedBy?: string;
}

// RBAC
interface CanvasPermissions {
  canView: boolean;
  canEdit: boolean;
  canReset: boolean;
}
```

---

### Database Tables (Post-Migration)

```sql
-- Canvas (NEW in Wave 3)
knosia_workspace_canvas (
  id, workspaceId UNIQUE,
  schema JSONB,
  sourceType ENUM,
  templateId, lastEditedBy,
  createdAt, updatedAt
)

-- RBAC (already exists)
knosia_workspace_membership (
  userId, workspaceId, roleId,
  permissions JSONB,
  status
)
```

---

### File Locations (New in Wave 3)

```
packages/
  api/src/modules/knosia/
    canvas/
      router.ts         ← Canvas API with RBAC

apps/web/src/modules/knosia/
  canvas/
    hooks/
      use-canvas-permissions.ts  ← RBAC hook
    components/
      canvas-workspace.tsx       ← Main component
      canvas-editor-toolbar.tsx  ← Edit controls
      block-palette.tsx          ← Add blocks UI
      editable-canvas.tsx        ← Edit mode wrapper
```

---

## Appendix: Architecture Diagrams

### Data Flow (Wave 0 → Wave 3)

```
Database Connection
    ↓
[Wave 1] Detect Business Type
    ↓
[Wave 1] Load Template (saas/ecommerce/...)
    ↓
[Wave 2] Generate DashboardSpec (data only)
    ↓
[Wave 2] Convert → LiquidSchema (adds layout)
    ↓
[Wave 3] Save to knosia_workspace_canvas
    ↓
[Wave 3] Render with LiquidUI
    ↓
[Wave 3] User Edits (if canEdit)
    ↓
[Wave 3] Save updated LiquidSchema
```

---

### Canvas Editing Flow (Wave 3)

```
User Role Check (RBAC)
    ↓
┌───────────┬────────────┐
│  Viewer   │  Admin     │
├───────────┼────────────┤
│ View only │ View + Edit│
└───────────┴────────────┘
                ↓
          [Edit Button]
                ↓
          Edit Mode ON
                ↓
    ┌─────────┴─────────┐
    ↓                   ↓
Add Block         Remove Block
    ↓                   ↓
Update LiquidSchema     │
    ↓                   ↓
    └─────────┬─────────┘
              ↓
        [Save Button]
              ↓
      POST /canvas/:id
              ↓
    RBAC Check (API)
              ↓
      Save to Database
              ↓
    Render Updated Canvas
```

---

## End of Document

**Version:** 1.0
**Date:** 2026-01-02
**Status:** Ready for Wave 1 execution

**Next Action:** Proceed to Wave 1 using `wave-1-foundation.md` (no changes).
