# ISS-117: Signal Persistence Model Evolution

**Issue Type:** Evolution Risk
**Category:** Extensibility and Evolution
**Priority:** Medium
**Affects:** Signal System (Section 10), Schema Versioning

---

## Problem Statement

Current signal persistence model (v2.0) is overly simple:

```typescript
interface SignalDefinition {
  type: SignalType;
  default?: unknown;
  persist?: 'none' | 'url' | 'session' | 'local';  // ← Too simple
  validation?: string;
}
```

This model lacks:
- **TTL (time-to-live)** - How long should session/local persist?
- **Scope** - User-specific? Organization-wide? Global?
- **Encryption** - Sensitive data in URLs?
- **Custom providers** - Database persistence? Redis? IndexedDB?
- **Synchronization** - Multi-tab consistency?

### Future Requirements (v3.0)

```typescript
// More sophisticated storage needs
storage?: {
  type: 'none' | 'url' | 'session' | 'local' | 'database' | 'custom';
  ttl?: number;                    // Seconds (NEW)
  scope?: 'user' | 'org' | 'global';  // (NEW)
  encryption?: boolean;            // (NEW)
  sync?: boolean;                  // Multi-tab sync (NEW)
  customProvider?: string;         // (NEW)
};
```

### Breaking Change

Field name changes from `persist` → `storage`, structure changes from string → object.

**Without migration machinery, this breaks all v2 schemas.**

---

## Resolution

### Evolution Strategy

Use the migration infrastructure (ISS-114) to gracefully evolve the persistence model.

### Implementation

#### 1. V2.0 Current Model (Baseline)

```typescript
// Current v2.0
interface SignalDefinition {
  type: SignalType;
  default?: unknown;
  persist?: 'none' | 'url' | 'session' | 'local';
  validation?: string;
}

// Example usage
signals: {
  dateRange: {
    type: 'dateRange',
    default: { start: new Date(), end: new Date() },
    persist: 'url'  // Simple string
  }
}
```

#### 2. V2.5 Transitional Model (Deprecation)

Add `storage` field while keeping `persist` for compatibility:

```typescript
// V2.5 - Both fields supported
interface SignalDefinition {
  type: SignalType;
  default?: unknown;

  // OLD (deprecated but still works)
  persist?: 'none' | 'url' | 'session' | 'local';  // @deprecated Use storage

  // NEW (preferred)
  storage?: SignalStorageConfig;

  validation?: string;
}

interface SignalStorageConfig {
  type: 'none' | 'url' | 'session' | 'local';
  ttl?: number;                    // Seconds (optional in v2.5)
  scope?: 'user';                  // Only 'user' in v2.5
}

// Auto-migration: If persist provided, convert to storage at load time
function normalizeSignal(signal: SignalDefinition): SignalDefinition {
  if (signal.persist && !signal.storage) {
    // Auto-convert
    return {
      ...signal,
      storage: { type: signal.persist, scope: 'user' },
      persist: undefined  // Remove deprecated field
    };
  }
  return signal;
}
```

#### 3. V3.0 Full Model (Breaking)

Remove `persist` field entirely, add advanced features:

```typescript
// V3.0 - persist field removed
interface SignalDefinition {
  type: SignalType;
  default?: unknown;

  // storage is now required if signal should persist
  storage?: SignalStorageConfig;  // No more 'persist'

  validation?: string;
}

interface SignalStorageConfig {
  // Core (from v2.5)
  type: 'none' | 'url' | 'session' | 'local' | 'database' | 'custom';  // ← Extended
  ttl?: number;                    // Seconds (now widely used)
  scope?: 'user' | 'org' | 'global';  // ← Extended

  // Advanced (NEW in v3.0)
  encryption?: boolean;            // Encrypt sensitive data
  sync?: boolean;                  // Multi-tab synchronization
  customProvider?: string;         // Custom storage provider name

  // Database-specific (when type='database')
  database?: DatabaseStorageConfig;
}

interface DatabaseStorageConfig {
  collection: string;              // Table/collection name
  key: string;                     // Primary key field
  indexes?: string[];              // Indexed fields
}

// Example v3.0 usage
signals: {
  patientContext: {
    type: 'patientContext',
    storage: {
      type: 'database',
      ttl: 3600,                   // 1 hour
      scope: 'org',                // Organization-wide
      encryption: true,            // Encrypt patient data
      sync: true,                  // Keep tabs in sync
      database: {
        collection: 'patient_contexts',
        key: 'sessionId',
        indexes: ['patientId', 'facilityId']
      }
    }
  }
}
```

#### 4. Migration V2.0 → V2.5

```typescript
registry.register({
  from: '2.0.0',
  to: '2.5.0',

  migrate: (schema: any): LiquidSchema => {
    const migrated = { ...schema, version: '2.5.0' };

    // Convert persist → storage (soft migration)
    if (migrated.signals) {
      for (const [name, signal] of Object.entries(migrated.signals)) {
        if (signal.persist && !signal.storage) {
          signal.storage = {
            type: signal.persist,
            scope: 'user',
            ttl: signal.persist === 'session' ? 3600 : undefined  // Default 1hr for session
          };
          // Keep persist for backward compat in 2.5
        }
      }
    }

    return migrated;
  },

  changelog: `
    - ADDED: signals.*.storage (preferred over persist)
    - DEPRECATED: signals.*.persist (use storage instead)
    - Default TTL: 1 hour for session storage
  `
});
```

#### 5. Migration V2.5 → V3.0

```typescript
registry.register({
  from: '2.5.0',
  to: '3.0.0',

  migrate: (schema: any): LiquidSchema => {
    const migrated = { ...schema, version: '3.0.0' };

    // Remove persist field (breaking!)
    if (migrated.signals) {
      for (const [name, signal] of Object.entries(migrated.signals)) {
        if (signal.persist) {
          // Ensure storage exists (should have been set in 2.5)
          if (!signal.storage) {
            signal.storage = {
              type: signal.persist,
              scope: 'user'
            };
          }

          delete signal.persist;  // Remove deprecated field
        }

        // Upgrade storage config if using old v2.5 format
        if (signal.storage && !signal.storage.encryption) {
          signal.storage.encryption = false;  // Explicit default
          signal.storage.sync = false;        // Explicit default
        }
      }
    }

    return migrated;
  },

  breakingChanges: [
    {
      field: 'signals.*.persist',
      reason: 'Replaced by storage for advanced persistence features',
      migration: 'Automatically migrated: persist → storage.type'
    }
  ],

  changelog: `
    - BREAKING: Removed signals.*.persist (use storage)
    - ADDED: storage.encryption for sensitive data
    - ADDED: storage.sync for multi-tab synchronization
    - ADDED: storage.customProvider for custom backends
    - ADDED: storage.database for database persistence
    - ADDED: storage.scope supports 'org' and 'global'
  `
});
```

#### 6. Storage Provider Interface (V3.0)

```typescript
// Custom storage providers
interface SignalStorageProvider {
  name: string;

  // Persistence operations
  get(signalName: string, scope: StorageScope): Promise<any>;
  set(signalName: string, value: any, scope: StorageScope, ttl?: number): Promise<void>;
  delete(signalName: string, scope: StorageScope): Promise<void>;

  // Multi-tab sync (optional)
  subscribe?(signalName: string, callback: (value: any) => void): () => void;

  // Metadata
  supportsEncryption: boolean;
  supportsSync: boolean;
  supportsScopes: StorageScope[];
}

type StorageScope = 'user' | 'org' | 'global';

// Registration
engine.storage.registerProvider('redis', new RedisStorageProvider({
  host: 'localhost',
  port: 6379
}));

// Usage in schema
signals: {
  globalTheme: {
    type: 'toggle',
    storage: {
      type: 'custom',
      customProvider: 'redis',
      scope: 'global',
      ttl: 86400  // 24 hours
    }
  }
}
```

---

## Migration Timeline

### 2025 - V2.0
- Simple `persist` field
- 4 options: none, url, session, local

### 2026 - V2.5 (Transitional)
- Add `storage` field (preferred)
- Deprecate `persist` (still works)
- Auto-migration persist → storage
- Warnings logged

### 2027 - V2.9
- Increased warnings about persist deprecation
- Documentation shows only `storage` examples
- Migration guide published

### 2028 - V3.0 (Breaking)
- Remove `persist` field
- Full `storage` feature set
- Automatic migration v2.x → v3.0

---

## Backward Compatibility Strategy

### V2.5 Compatibility Layer

```typescript
// Runtime normalization in v2.5
class SignalRuntime {
  createSignal(definition: SignalDefinition): Signal {
    // Normalize old persist to new storage
    const normalized = normalizeSignal(definition);

    // Emit deprecation warning if persist was used
    if (definition.persist && !definition.storage) {
      console.warn(
        `Signal uses deprecated 'persist' field. ` +
        `Replace with 'storage: { type: "${definition.persist}" }'. ` +
        `Support for 'persist' will be removed in v3.0.`
      );
    }

    return this.createFromStorage(normalized.storage);
  }
}
```

### V3.0 Migration Enforcement

```typescript
// Engine refuses to load v2.0 schemas without migration
class LiquidEngine {
  loadSchema(schema: any): LiquidSchema {
    const version = SchemaVersion.parse(schema.version);

    if (version.major < 3) {
      // Auto-migrate
      const migrated = this.evolution.migrate(schema, '3.0.0');

      console.info(
        `Schema auto-migrated from ${schema.version} to 3.0.0. ` +
        `Save migrated version to avoid this warning.`
      );

      return migrated;
    }

    return schema;
  }
}
```

---

## Benefits

### User Benefits
- **Smooth transition** - v2.5 gives 2+ years to migrate
- **Auto-migration** - Old schemas just work
- **Clear warnings** - Deprecation notices guide updates

### Feature Benefits
- **TTL support** - Prevent stale data
- **Scoping** - Multi-tenancy, organization-wide settings
- **Encryption** - Protect sensitive signals
- **Sync** - Multi-tab consistency
- **Extensibility** - Custom storage backends

---

## Testing Requirements

```typescript
describe('Signal Storage Migration', () => {
  it('migrates v2.0 persist to v2.5 storage', () => {
    const v2 = {
      version: '2.0.0',
      signals: {
        test: { type: 'dateRange', persist: 'url' }
      }
    };

    const v2_5 = migrator.migrate(v2, '2.5.0');

    expect(v2_5.signals.test.storage).toEqual({
      type: 'url',
      scope: 'user',
      ttl: undefined
    });
  });

  it('removes persist in v3.0 migration', () => {
    const v2_5 = {
      version: '2.5.0',
      signals: {
        test: {
          type: 'dateRange',
          persist: 'url',
          storage: { type: 'url', scope: 'user' }
        }
      }
    };

    const v3 = migrator.migrate(v2_5, '3.0.0');

    expect(v3.signals.test.persist).toBeUndefined();
    expect(v3.signals.test.storage.type).toBe('url');
  });

  it('warns about deprecated persist in v2.5', () => {
    const consoleSpy = jest.spyOn(console, 'warn');

    runtime.createSignal({
      type: 'dateRange',
      persist: 'url'  // Using deprecated field
    });

    expect(consoleSpy).toHaveBeenCalledWith(
      expect.stringContaining('deprecated')
    );
  });
});
```

---

## Documentation Requirements

### Migration Guide

**Title:** "Migrating from persist to storage (v2.x → v3.0)"

**Contents:**
1. Why the change (limitations of persist)
2. What's new in storage
3. Automatic migration behavior
4. Manual migration steps (if needed)
5. Timeline (v2.5 deprecation → v3.0 removal)
6. Examples: before/after

### New Features Guide

**Title:** "Advanced Signal Persistence (v3.0)"

**Contents:**
1. TTL configuration
2. Scoping (user/org/global)
3. Encryption for sensitive data
4. Multi-tab synchronization
5. Custom storage providers
6. Database persistence

---

## Implementation Checklist

### V2.5 Release
- [ ] Add `storage` field to `SignalDefinition`
- [ ] Implement auto-migration persist → storage
- [ ] Add deprecation warnings
- [ ] Update documentation
- [ ] Create migration guide

### V3.0 Release
- [ ] Remove `persist` field from types
- [ ] Implement full storage feature set
- [ ] Add encryption support
- [ ] Add sync support
- [ ] Add custom provider interface
- [ ] Update all examples

---

## Resolution Status

**Status:** Resolved
**Specification Impact:** High (breaking change in v3.0)
**Breaking Changes:** Yes (persist removed in v3.0)
**Version Target:** v2.5 (deprecation), v3.0 (removal)

**Rationale Integration:** This demonstrates the evolution machinery (ISS-114) in action. A real-world breaking change (persistence model) is handled gracefully with a 2-year deprecation period, auto-migration, and clear communication. This pattern applies to all future breaking changes.

**Dependency:** Requires ISS-114 (Schema Migration Strategy) to be implemented first.
