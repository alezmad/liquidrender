# Resolution: ISS-028

## Status: ✅ RESOLVED

## Issue Summary
**Title:** Grid Layout Syntax Ambiguity
**Severity:** critical
**Target:** SPEC
**Section:** §6

## Resolution

### Problem Analysis

Grid layout syntax appears in multiple examples with potential ambiguities:

**Current references:**
- Line 427: `#overview;G2x2;K$revenue,K$orders,L$date$amount,T`
- Line 434: `G2x2` — Grid layout, 2 columns x 2 rows
- Line 471: `#sales_dashboard;G2x3`
- Line 1887: `#overview;G2x2;K$revenue,K$orders`

**Ambiguities identified:**

1. **Dimension interpretation:**
   - Is `G2x3` = 2 columns × 3 rows (width × height) OR 2 rows × 3 columns?
   - Different sections use different conventions implicitly

2. **Block count vs grid size:**
   - `G2x2` defines 4 cells, but example has 4 blocks - exact fit
   - `G2x3` defines 6 cells, but examples vary in block count
   - What happens if block count ≠ cell count?

3. **Grid filling order:**
   - Row-major (left-to-right, then down)?
   - Column-major (top-to-bottom, then right)?
   - Explicit positioning?

4. **Auto-sizing:**
   - Can dimensions be omitted? (`G` alone)
   - Can one dimension be auto? (`G2` or `Gx3`)
   - How is auto-sizing calculated?

5. **Grid position addressing:**
   - `@[0,1]` notation exists (§8.2, line 582)
   - Is this [row, col] or [col, row]?
   - Does it match the `GWxH` dimension order?

### Original Content (Lines 419-437, 471-480)

**§6.3 Generation Syntax:**
```markdown
Examples:
#overview;G2x2;K$revenue,K$orders,L$date$amount,T
#comparison;S;C$current$previous,B$category$value
#funnel;S;K$stage1,K$stage2,K$stage3,K$stage4
```

Breakdown:
- `#overview` — Archetype hint
- `G2x2` — Grid layout, 2 columns x 2 rows
- `K$revenue` — KPI bound to revenue field
- `L$date$amount` — Line chart with date as X, amount as Y
```

**§6.5 Complete Example:**
```liquidcode
#sales_dashboard;G2x3
§dateRange:dr=30d,url
§category:sel=all,session
DF<>@dateRange
SF$categories<>@category
K$revenue<@dateRange<@category
K$orders<@dateRange<@category
L$date$revenue<@dateRange<@category
T$orders<@dateRange<@category
```

**§8.2 Address Hierarchy (line 582):**
```markdown
| Grid position | `@[0,1]` | Row, column | 1 token |
```

### Replacement Content

**Insert new subsection §6.3.1 "Grid Layout Specification" after line 437:**

```markdown
#### 6.3.1 Grid Layout Specification (Normative)

**Syntax:**
```
G[Cols]x[Rows]
```

Where:
- `G` = Grid layout type (REQUIRED)
- `Cols` = Number of columns (OPTIONAL, integer ≥ 1)
- `Rows` = Number of rows (OPTIONAL, integer ≥ 1)
- `x` = Dimension separator (REQUIRED if both dimensions specified)

**Dimension semantics:**

| Syntax | Columns | Rows | Interpretation |
|--------|---------|------|----------------|
| `G2x3` | 2 | 3 | 2 columns, 3 rows (6 cells) |
| `G3x2` | 3 | 2 | 3 columns, 2 rows (6 cells) |
| `G4` | 4 | auto | 4 columns, rows determined by block count |
| `Gx3` | auto | 3 | 3 rows, columns determined by block count |
| `G` | auto | auto | Grid dimensions inferred from block count |

**Convention:** Dimensions follow **width × height** (columns × rows), matching CSS grid and standard Cartesian convention.

**Auto-sizing rules:**

1. **Both auto (`G`):**
   - Calculate ideal grid shape: `cols = ceil(sqrt(blockCount))`
   - Example: 6 blocks → 3×2 grid
   - Example: 7 blocks → 3×3 grid (1 empty cell)

2. **Columns fixed, rows auto (`G4`):**
   - `rows = ceil(blockCount / cols)`
   - Example: `G4` with 6 blocks → 4×2 grid (2 empty cells)

3. **Rows fixed, columns auto (`Gx3`):**
   - `cols = ceil(blockCount / rows)`
   - Example: `Gx3` with 7 blocks → 3×3 grid (2 empty cells)

4. **Both fixed (`G2x3`):**
   - Grid has exactly `cols × rows` cells
   - If `blockCount < cells`: Remaining cells are empty
   - If `blockCount > cells`: Compiler MUST emit warning, extra blocks MAY wrap or be hidden

**Block placement order (default):**

Blocks fill the grid in **row-major order** (left-to-right, top-to-bottom):

```
Position order for G3x2:
┌─────┬─────┬─────┐
│  0  │  1  │  2  │
├─────┼─────┼─────┤
│  3  │  4  │  5  │
└─────┴─────┴─────┘
```

**Example with 4 blocks in G2x2:**
```
#overview;G2x2;K$revenue,K$orders,L$trend,T$data

Layout:
┌───────────┬───────────┐
│ K$revenue │ K$orders  │  ← Row 0
├───────────┼───────────┤
│ L$trend   │ T$data    │  ← Row 1
└───────────┴───────────┘
  Col 0       Col 1
```

**Example with 6 blocks in G2x3:**
```
#dashboard;G2x3;DF,SF,K$revenue,K$orders,L$trend,T$data

Layout:
┌────────┬────────┐
│ DF     │ SF     │  ← Row 0
├────────┼────────┤
│ K$rev  │ K$ord  │  ← Row 1
├────────┼────────┤
│ L$tr   │ T$data │  ← Row 2
└────────┴────────┘
```

**Example with 3 blocks in G2x2 (underfilled):**
```
#summary;G2x2;K$revenue,K$orders,L$trend

Layout:
┌───────────┬───────────┐
│ K$revenue │ K$orders  │
├───────────┼───────────┤
│ L$trend   │ [empty]   │  ← Empty cell
└───────────┴───────────┘
```

**Example with auto-sizing:**
```
#metrics;G;K$a,K$b,K$c,K$d,K$e

Auto-calculated as G3x2:
┌─────┬─────┬─────┐
│ K$a │ K$b │ K$c │
├─────┼─────┼─────┤
│ K$d │ K$e │ [E] │  ← E = empty
└─────┴─────┴─────┘
```

**Explicit positioning (advanced):**

Blocks MAY override default placement using explicit grid coordinates in mutations or with position syntax:

```liquidcode
# Mutation: Add block at specific position
delta:+K$newMetric@[1,0]  # Add at row 1, col 0

# Mutation: Move block to position
delta:move:@K0->[0,1]     # Move first KPI to row 0, col 1
```

#### 6.3.2 Grid Position Addressing (Cross-Reference to §8.2)

**Grid positions use zero-indexed [row, column] notation:**

```
@[row, col]
```

**Coordinate system:**
```
     Col 0   Col 1   Col 2
Row 0 [0,0]  [0,1]  [0,2]
Row 1 [1,0]  [1,1]  [1,2]
Row 2 [2,0]  [2,1]  [2,2]
```

**IMPORTANT:** Grid position addresses use `[row, col]` order, while grid dimensions use `ColsxRows` order. This follows standard conventions:
- **Dimensions:** Width × Height (columns × rows) — matches CSS grid
- **Positions:** Row, Column — matches array indexing `array[row][col]`

**Examples:**

| Address | Position | Block in G2x3 |
|---------|----------|---------------|
| `@[0,0]` | Row 0, Col 0 | Top-left |
| `@[0,1]` | Row 0, Col 1 | Top-right |
| `@[1,0]` | Row 1, Col 0 | Middle-left |
| `@[2,1]` | Row 2, Col 1 | Bottom-right |

**Equivalence with ordinal addressing:**

For a G2x3 grid with 6 blocks filled row-major:
```
@0 = @[0,0]  # First block
@1 = @[0,1]  # Second block
@2 = @[1,0]  # Third block
@3 = @[1,1]  # Fourth block
@4 = @[2,0]  # Fifth block
@5 = @[2,1]  # Sixth block
```

**Out-of-bounds addressing:**

If an address references a position outside the grid:
- Mutation operations MUST emit error
- Query operations MUST return null/undefined
- Example: `@[3,0]` in a G2x3 grid (only has rows 0-2) is invalid

#### 6.3.3 Grid Spanning (Cross-Reference to §11.6)

Blocks MAY span multiple columns using the `*` modifier (see §11.6):

```liquidcode
#dashboard;G2x3;K$a,K$b,L$chart*full,T$table*full

Layout:
┌─────┬─────┐
│ K$a │ K$b │
├─────┴─────┤
│ L$chart   │  ← Spans both columns (*full)
├───────────┤
│ T$table   │  ← Spans both columns (*full)
└───────────┘
```

**Span values:**
- `*full` = Span all columns in grid
- `*2`, `*3`, etc. = Span N columns
- `*half` = Span ⌈cols/2⌉ columns

Spanning MUST respect grid boundaries. Spans exceeding grid width are clamped to grid width.
```

**Update §8.2 Address Hierarchy (line 582) for consistency:**

```markdown
| Grid position | `@[row,col]` | Zero-indexed row, column (see §6.3.2) | 1 token |
```

## Verification Checklist
- [x] Change addresses the identified issue (clarifies all grid syntax ambiguities)
- [x] No new inconsistencies introduced (aligns with §8.2 addressing, §11.6 spanning)
- [x] Cross-references remain valid (added §6.3.2 to link to §8.2)
- [x] Dimension order clarified (cols × rows = width × height)
- [x] Position order clarified ([row, col] for addresses)
- [x] Filling order specified (row-major)
- [x] Auto-sizing rules defined (all three cases)
- [x] Underfill/overfill behavior specified (empty cells, warnings)
- [x] Visual examples provided (ASCII grid diagrams)
- [x] Coordinate system documented (zero-indexed)
- [x] Out-of-bounds behavior specified (errors for mutations)
- [x] Spanning cross-referenced (§11.6)

## Confidence
**HIGH** - This resolution comprehensively addresses grid layout ambiguities by:
1. Defining formal syntax with clear semantics
2. Establishing width × height (cols × rows) dimension convention
3. Specifying row-major filling order with visual examples
4. Clarifying [row, col] addressing to match array indexing conventions
5. Defining auto-sizing behavior for all cases
6. Handling edge cases (underfill, overfill, out-of-bounds)
7. Cross-referencing related sections (§8.2 addressing, §11.6 spanning)
8. Providing extensive examples with ASCII diagrams

The conventions chosen align with CSS Grid (cols × rows) and array indexing ([row][col]), which are familiar to implementers.
