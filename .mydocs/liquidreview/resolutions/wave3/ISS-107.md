# ISS-107: Malformed LiquidCode Syntax

**Category:** Minor Edge Cases
**Priority:** Medium
**Status:** Resolved

## Issue

When the LLM generates syntactically invalid LiquidCode (missing semicolons, mismatched brackets, unknown operators), how should the parser recover to provide helpful feedback?

## Resolution

### Parser Recovery Strategy

**The parser uses error recovery to provide actionable diagnostics, but does NOT auto-fix syntax errors.**

### Error Levels

| Level | Behavior | Example |
|-------|----------|---------|
| **Fatal** | Reject compilation | Missing required archetype |
| **Recoverable** | Skip section, continue parsing | Malformed signal, rest of schema valid |
| **Warning** | Accept with warning | Unknown block type (render as placeholder) |

### Recovery Tactics

```typescript
interface ParseError {
  level: 'fatal' | 'recoverable' | 'warning';
  location: { line: number; column: number; };
  code: string;              // Error code (e.g., 'E001')
  message: string;           // Human-readable
  suggestion?: string;       // Recovery suggestion
  context?: string;          // Surrounding code
}

// Example errors
const ERRORS = {
  E001: {
    level: 'fatal',
    pattern: /^#[^;]/,
    message: 'Missing semicolon after archetype',
    suggestion: 'Add semicolons: #archetype;layout;blocks'
  },
  E002: {
    level: 'recoverable',
    pattern: /§\w+:[^=]/,
    message: 'Malformed signal declaration',
    suggestion: 'Use format: §name:type=default,persist'
  },
  E003: {
    level: 'warning',
    pattern: /[A-Z]{3,}/,
    message: 'Unknown block type code',
    suggestion: 'Use standard codes (K, B, L, P, T, G, S) or custom:name'
  }
};
```

### Recovery Algorithm

```
1. Tokenize input
2. For each token:
   a. Try to match expected grammar rule
   b. If mismatch:
      - Check error patterns
      - Classify error level
      - Generate suggestion
   c. If fatal: abort and return errors
   d. If recoverable: skip to next valid section
   e. If warning: continue with placeholder
3. Return partial schema + error list
```

### Example Recovery

```liquidcode
// Malformed input
#overview;G2x2K$revenue,L$date$amount  // Missing semicolon before blocks

// Parser output
{
  success: false,
  errors: [
    {
      level: 'recoverable',
      location: { line: 1, column: 13 },
      code: 'E004',
      message: 'Missing semicolon before block list',
      suggestion: 'Insert semicolon: #overview;G2x2;K$revenue...',
      context: '#overview;G2x2K$revenue'
    }
  ],
  partialSchema: {
    // L0 structure recovered
    archetype: 'overview',
    layout: { type: 'grid', columns: 2, rows: 2 },
    blocks: []  // Blocks section skipped
  }
}
```

### User Feedback

When LLM generates malformed syntax:

1. **Return errors to LLM** with recovery suggestions
2. **LLM retries** with corrected syntax (single retry)
3. If retry fails, **escalate to user** with diagnostic

### Diagnostic Format

```
Error: Malformed LiquidCode syntax

Location: Line 1, Column 13
Code: E004

#overview;G2x2K$revenue,L$date$amount
             ^
Missing semicolon before block list

Suggestion: Insert semicolon between layout and blocks
Corrected: #overview;G2x2;K$revenue,L$date$amount
```

## Specification Impact

**Addition to §17.1 (Compilation Pipeline):**

Add "Parser Recovery" step between Tokenizer and Semantic Analyzer.

**New section §17.5 (Error Recovery):**

Define error levels, recovery tactics, and diagnostic format.

## Related Sections

- §17.1: LiquidCode → LiquidSchema compilation
- §19.1: Error Categories
