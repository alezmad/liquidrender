# ISS-108: Schema Versioning Forward Compatibility

**Category:** Minor Edge Cases
**Priority:** Medium
**Status:** Resolved

## Issue

When a v2.0 engine encounters a schema with `version: "2.1"` (future minor version with new optional fields), how should it handle unknown fields?

## Resolution

### Forward Compatibility Rules

**Semantic versioning applies to LiquidSchema:**

| Version Change | Compatibility | Handling |
|----------------|---------------|----------|
| Patch (2.0 → 2.0.1) | Fully compatible | No changes to schema structure |
| Minor (2.0 → 2.1) | Forward-compatible | New optional fields, old engines ignore |
| Major (2.x → 3.0) | Breaking | Old engines reject, migration required |

### Unknown Field Handling

```typescript
interface VersionCompatibility {
  engineVersion: string;       // "2.0.0"
  schemaVersion: string;       // "2.1.0"
  compatible: boolean;         // true if parseable
  warnings: string[];          // Unknown fields encountered
}

function checkCompatibility(
  schema: LiquidSchema,
  engineVersion: string
): VersionCompatibility {
  const [schemaMajor, schemaMinor] = schema.version.split('.').map(Number);
  const [engineMajor, engineMinor] = engineVersion.split('.').map(Number);

  // Major version mismatch → incompatible
  if (schemaMajor !== engineMajor) {
    return {
      engineVersion,
      schemaVersion: schema.version,
      compatible: false,
      warnings: [`Schema version ${schema.version} requires engine ${schemaMajor}.x`]
    };
  }

  // Minor version ahead → compatible with warnings
  const warnings: string[] = [];
  if (schemaMinor > engineMinor) {
    warnings.push(
      `Schema version ${schema.version} is newer than engine ${engineVersion}. ` +
      `Some features may be ignored.`
    );
  }

  return { engineVersion, schemaVersion: schema.version, compatible: true, warnings };
}
```

### Strict vs. Permissive Parsing

```typescript
interface ParseOptions {
  strictVersion: boolean;      // Reject if minor version ahead
  strictSchema: boolean;       // Reject unknown fields
  warnOnUnknown: boolean;      // Emit warnings for unknown fields
}

// Default: permissive (forward-compatible)
const DEFAULT_PARSE_OPTIONS: ParseOptions = {
  strictVersion: false,        // Accept newer minor versions
  strictSchema: false,         // Ignore unknown fields
  warnOnUnknown: true          // Warn about ignored fields
};

// Validation schema (Zod)
const LiquidSchemaSchema = z.object({
  version: z.string().regex(/^\d+\.\d+(\.\d+)?$/),
  // ... required fields
})
.passthrough()  // Allow unknown fields (forward compat)
.superRefine((schema, ctx) => {
  const unknown = Object.keys(schema).filter(
    k => !KNOWN_FIELDS_V2.includes(k)
  );
  if (unknown.length > 0 && parseOptions.warnOnUnknown) {
    ctx.addIssue({
      code: z.ZodIssueCode.custom,
      message: `Unknown fields (may be from newer version): ${unknown.join(', ')}`,
      path: []
    });
  }
});
```

### Backward Compatibility (Migration)

When a v2.1 engine encounters v2.0 schema:

```typescript
// Automatically backfill new optional fields with defaults
function backfillDefaults(schema: LiquidSchema): LiquidSchema {
  return {
    ...schema,
    // v2.1 added optional field 'theme'
    theme: schema.theme ?? 'default',
    // Ensure all blocks have new optional field
    blocks: schema.blocks.map(block => ({
      ...block,
      accessibility: block.accessibility ?? { ariaLabel: block.id }
    }))
  };
}
```

### Version Declaration

```typescript
interface LiquidSchema {
  version: string;             // Semver: "2.0", "2.1.0", etc.

  // Optional: minimum engine version required
  minEngineVersion?: string;   // "2.0.0"

  // ... rest of schema
}
```

### Example Scenarios

| Schema Version | Engine Version | Result |
|----------------|----------------|--------|
| 2.0 | 2.0 | ✅ Full support |
| 2.0 | 2.1 | ✅ Full support (with backfill) |
| 2.1 | 2.0 | ✅ Works, ignores new fields, warns |
| 2.1 | 2.0 (strict) | ❌ Rejected (strict mode) |
| 3.0 | 2.x | ❌ Incompatible (major version) |

## Specification Impact

**Update §20.2 (Version Compatibility):**

Replace simple table with detailed forward/backward compatibility rules.

**New section §20.5 (Forward Compatibility):**

Define unknown field handling and strict/permissive parsing modes.

## Related Sections

- §20.1: Schema Versioning
- §20.2: Version Compatibility
- §20.3: Migration Path
